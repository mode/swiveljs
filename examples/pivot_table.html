<html ng-app="PivotTable">
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.3/angular.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.css" />

    <script src="swivel.all.js"></script>

    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css" />
  </head>

  <body ng-controller="PivotTableController">
    <h1>Pivot Table Example</h1>
    <p>Total events by day for each location</p>

    <form id="pivot-settings">
      <div>
        <div class="settings-label">Rows</div>

        <select ng-model="rows">
          <option value="day">Day</option>
          <option value="device">Device</option>
          <option value="location">Location</option>
        </select>
      </div>

      <div>
        <div class="settings-label">Columns</div>

        <select ng-model="columns">
          <option value="day">Day</option>
          <option value="device">Device</option>
          <option value="location">Location</option>
        </select>
      </div>

      <div id="pivot-values">
        <div class="settings-label">Values</div>

        <select ng-model="valueField">
          <option value="day">Day</option>
          <option value="device">Device</option>
          <option value="location">Location</option>
          <option value="events">Events</option>
          <option value="user_id">User ID</option>
        </select>

        <select ng-model="valueFn">
          <option value="sum">Sum</option>
          <option value="count">Count</option>
          <option value="countUnique">Unique</option>
          <option value="average">Average</option>
          <option value="median">Median</option>
          <option value="stdDev">Standard Deviation</option>
        </select>
      </div>
    </form>

    <div id="pivot-container"></div>

    <script type="text/javascript">
      var app = angular.module("PivotTable", []);

      app.controller("PivotTableController", ['$scope', function($scope) {
        $scope.pivot;

        $scope.rows       = 'day';
        $scope.columns    = 'location';
        $scope.valueFn    = 'sum';
        $scope.valueField = 'events';

        var dateFormat = d3.time.format("%Y-%m-%d");
        var dateParser = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

        var renderTable = function() {
          var pivotted = $scope.pivot
            .fields($scope.rows, $scope.columns)
            .pivots($scope.columns)
            .select(swivel.aggregate($scope.valueFn, $scope.valueField), $scope.valueField)
            .all();

          var sortedData = pivotted.data.sort(function(r1, r2) {
            var v1 = r1[$scope.rows];
            var v2 = r2[$scope.rows];

            if ( v1 < v2 ) {
              return -1;
            } else if ( v1 > v2 ) {
              return 1;
            } else {
              return 0;
            }
          });

          var columnValues = pivotted.values($scope.columns).sort();

          d3.select("#pivot-container table").remove(); // clean out old table
          var table = d3.select("#pivot-container").append("table"),
            thead = table.append("thead"),
            tbody = table.append("tbody");

          thead.append("tr")
            .selectAll("td")
              .data(function() {
                var columns = [$scope.rows];
                for(var i = 0; i < columnValues.length; i++) {
                  columns.push(columnValues[i]);
                }
                return columns;
              }).enter().append("td")
            .text(function(column){ return column; });

          tbody.selectAll("tr")
            .data(sortedData)
            .enter().append("tr")
          .selectAll("td")
            .data(function(row) {
              var values = [row[$scope.rows]];
              for(var i = 0; i < columnValues.length; i++) {
                values.push(row[columnValues[i]]);
              }
              return values;
            }).enter().append("td")
          .text(function(row){ return row; })
        }

        datasets.events(function(dataset) {
          $scope.pivot = swivel.data(dataset);

          renderTable();
        });

        $scope.$watch('rows', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('columns', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('valueFn', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('valueField', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

      }]);
    </script>
  </body>
</html>
