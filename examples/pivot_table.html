<html>
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.3/angular.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.css" />

    <script src="swivel.all.js"></script>

    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <h1>Pivot Table Example</h1>
    <p>Total events by day for each location</p>

    <form id="pivot-settings">
      <div>
        <div class="settings-label">Rows</div>

        <select>
          <option>Day</option>
          <option>Device</option>
          <option>Location</option>
        </select>
      </div>

      <div>
        <div class="settings-label">Columns</div>

        <select>
          <option>Day</option>
          <option>Device</option>
          <option>Location</option>
        </select>
      </div>

      <div id="pivot-values">
        <div class="settings-label">Values</div>

        <select>
          <option>Day</option>
          <option>Device</option>
          <option>Location</option>
          <option>Events</option>
        </select>

        <select>
          <option>Sum</option>
          <option>Count</option>
          <option>Unique</option>
          <option>Average</option>
          <option>Median</option>
          <option>Standard Deviation</option>
        </select>
      </div>
    </form>

    <div id="pivot-container"></div>

    <script type="text/javascript">
      datasets.events(function(dataset) {

        //
        // 'day': Date.parse(row['day']),
        // 'event_name': row['event_name'],
        // 'location': row['location'],
        // 'device': row['device'],
        // 'user_id': row['user_id'],
        // 'events': +row['events']
        //

        var dayFormat = d3.time.format("%Y-%m-%d");
        var dayParser = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

        var pivot = swivel
          .data(dataset)
          .fields('day', 'location').pivots('location')
          .select(swivel.sum('events'), 'Total Events')
          .all();

        var locations = pivot.values('location');

        var table = d3.select("#pivot-container").append("table"),
            thead = table.append("thead"),
            tbody = table.append("tbody");

        thead.append("tr")
        .selectAll("td")
          .data(function() {
            var columns = ['Day'];
            for(var i = 0; i < locations.length; i++) {
              columns.push(locations[i]);
            }
            return columns;
          }).enter().append("td")
        .text(function(column){ return column; });

        tbody.selectAll("tr")
          .data(pivot.data)
          .enter().append("tr")
        .selectAll("td")
          .data(function(row) {
            var day = row['day'];
            var day = dayParser(day);
            var values = [dayFormat(day)];
            for(var i = 0; i < locations.length; i++) {
              values.push(row[locations[i]]);
            }
            return values;
          }).enter().append("td")
        .text(function(row){ return row; })
      });
    </script>
  </body>
</html>
