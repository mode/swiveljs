<html ng-app="PivotTable">
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.3/angular.min.js"></script>

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script src="swivel.js"></script>

    <script src="index.js"></script>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css" />
  </head>

  <body ng-controller="PivotTableController">
    <h3>
      <a href="/index.html">Swivel Examples</a>
    </h3>

    <div id="main" class="container-fluid">
      <div class="row">
        <div class="col-md-9">
          <!-- Filters go here -->
          <div id="pivot-container"></div>
        </div>

        <div id="excel-pivot-settings" class="col-md-3">

          <span class="field-header">Fields</span>
          <div id="field-list" class="field-list">
            <label class="field-item" ng-repeat="field in fields" for="field-{{ field.name }}">
              <input  id="field-{{ field.name }}"  type="checkbox" ng-checked="field.selected" disabled="true"> {{ field.label }}
            </label>
          </div>

          <div class="col-md-6">
            <span class="field-header">Filters</span>
            <ul class="field-list field-droppable">
              <!-- filters -->
              <span class="field-item-label field-item-filter" ng-repeat="field in fields | filter: { selection: { group: 'filters' } }">

              </span>
            </ul>
          </div>

          <div class="col-md-6">
            <span class="field-header">Colums</span>

            <ul class="field-list field-droppable">
              <span class="field-item-label field-item-column" ng-repeat="field in fields | filter: { selection: { group: 'columns' } }">
                {{ field.name }}
              </span>
            </ul>
          </div>

          <div class="col-md-6">
            <span class="field-header">Rows</span>

            <ul class="field-list field-droppable">
              <span class="field-item-label field-item-row" ng-repeat="field in fields | filter: { selection: { group: 'rows' } }">
                {{ field.name }}
              </span>
            </ul>
          </div>

          <div class="col-md-6">
            <span class="field-header">Values</span>

            <ul class="field-list field-droppable">
              <span class="field-item-label field-item-row" ng-repeat="field in fields | filter: { selection: { group: 'values' } }">
                {{ field.selection.valueFn }} of {{ field.name }}
              </span>
            </ul>
          </div>

        </div>
      </div>

    </div>

    <script type="text/javascript">
      var app = angular.module("PivotTable", []);

      app.controller("PivotTableController", ['$scope', function($scope) {
        $scope.data;
        $scope.rows       = 'day';
        $scope.columns    = '';
        $scope.valueFn    = 'sum';
        $scope.valueField = 'events';

        $scope.fields = [
          {
            name: 'day',
            label: 'Day',
            type: 'datetime',
            selected: true,
            selection: {
              group: 'rows'
            }
          },
          {
            name: 'user_id',
            label: 'User ID',
            type: 'number',
            selected: false,
            selection: {}
          },
          {
            name: 'device',
            label: 'Device',
            type: 'string',
            selected: false,
            selection: {}
          },
          {
            name: 'location',
            label: 'Location',
            type: 'string',
            selected: false,
            selection: {}
          },
          {
            name: 'event_name',
            label: 'Event Name',
            type: 'string',
            selected: false,
            selection: {}
          },
          {
            name: 'events',
            label: 'Events',
            type: 'number',
            selected: true,
            selection: {
              group: 'values',
              valueFn: 'sum'
            }
          }
        ]

        var dateFormat = d3.time.format("%Y-%m-%d");
        var dateParser = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

        var renderTable = function() {
          var pivoted = swivel($scope.data)
            .group($scope.rows)
            .pivot($scope.columns)
            .aggregate($scope.valueFn, $scope.valueField)
            .all();

          var sortedData = pivoted.data.sort(function(r1, r2) {
            var v1 = r1[$scope.rows];
            var v2 = r2[$scope.rows];

            if ( v1 < v2 ) {
              return -1;
            } else if ( v1 > v2 ) {
              return 1;
            } else {
              return 0;
            }
          });

          var columnValues = pivoted.values($scope.columns).sort();

          d3.select("#pivot-container table").remove(); // clean out old table
          var table = d3.select("#pivot-container").append("table").attr('class', 'table'),
            thead = table.append("thead"),
            tbody = table.append("tbody");

          thead.append("tr")
            .selectAll("td")
              .data(function() {
                var columns = [$scope.rows];

                if($scope.columns == '') {
                  columns.push($scope.valueField);
                } else {
                  for(var i = 0; i < columnValues.length; i++) {
                    columns.push(columnValues[i]);
                  }
                }

                return columns;
              }).enter().append("td")
            .text(function(column){ return column; });

          tbody.selectAll("tr")
            .data(sortedData)
            .enter().append("tr")
          .selectAll("td")
            .data(function(row) {
              var values = [row[$scope.rows]];

              for(var i = 0; i < columnValues.length; i++) {
                values.push(row[columnValues[i]]);
              }
              return values;
            }).enter().append("td")
          .text(function(row){ return row; })
        }

        datasets.events(function(dataset) {
          $scope.data = dataset;
          renderTable();
        });

        $scope.$watch('rows', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('columns', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('valueFn', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

        $scope.$watch('valueField', function(value, oldValue) {
          if(angular.isDefined(value) && value !== oldValue) {
            renderTable();
          }
        });

      }]);

      $(function() {
        $(".field-item").draggable({
          helper: "clone",
          revert: "invalid"
        });

        $('.field-droppable').droppable({
          accept: '.field-item',
          drop: function(event, ui) {
            $(this).append($(ui.draggable).clone());
          }
        });
      });
    </script>
  </body>
</html>
