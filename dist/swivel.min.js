function swivel(e){function n(e){return j=j.concat(e),this}function t(e){for(var n=e.fields,t=e.filters,r=e.aggregates,u=0;u<n.length;u++){var o=n[u];this[o.type](o.name)}for(var u=0;u<t.length;u++)i(t[u].test);for(var u=0;u<r.length;u++){var s=r[u];a(s.type,s.field,{as:s.as})}return this}function r(){for(var e=[].concat(swivel.args(arguments)),n=0;n<e.length;n++)q.field(e[n]),y.push({type:"group",name:e[n]});return this}function u(){for(var e=[].concat(swivel.args(arguments)),n=0;n<e.length;n++)q.field(e[n]),y.push({type:"pivot",name:e[n]});return this}function i(e){return k.push(Function("row","return "+e+";")),this}function a(e,n,t){return"undefined"==typeof t&&(t={}),b.push({as:t.as||n,callback:swivel.aggregate(e,n,t)}),this}function o(e,n){return a.call(this,"count",e,n)}function s(e,n){return a.call(this,"countUnique",e,n)}function l(e,n){return a.call(this,"sum",e,n)}function c(e,n){return a.call(this,"average",e,n)}function f(e,n){return a.call(this,"median",e,n)}function v(e,n){return a.call(this,"stdDev",e,n)}function g(){h();var e={values:function(e){return q.isEmpty()?[]:Object.keys(q.getValues(e))}};return e.data=q.isEmpty()?[]:"group"==y[0].type?m(q.getRoot(),0):d(q.getRoot(),0),e}function h(){for(var e=0;e<j.length;e++){for(var n=j[e],t=!0,r=0;r<k.length;r++)if(0==k[r](n)){t=!1;break}t&&q.insert(n,e)}}function p(){for(var e=[],n=0;n<y.length;n++)e.push(y[n].name);return e}function w(e){for(var n=[],t=0;t<e.length;t++)n.push(j[e[t]]);for(var r={},t=0;t<b.length;t++){var u=b[t];r[u.as]=u.callback(n)}return r}function m(e,n){for(var t=[],r=[],u=n,i=p(),a=n;a<i.length&&"group"==y[a].type;a++)u+=1,r.push(i[a]);var o=y[u];return q.eachBranch({},e,r,0,function(e,n){var r={};swivel.merge(r,n),u==i.length?swivel.merge(r,w(e)):"pivot"==o.type&&swivel.merge(r,d(e,u)),t.push(r)}),t}function d(e,n){var t={},r=n+1,u=p(),i=y[r];return q.eachValue(e,n,function(e,n){var a={};if("undefined"==typeof e)a[n]=null;else if(r==u.length){var o=w(e),s=Object.keys(o);a[n]=1==s.length?o[s[0]]:o}else"group"==i.type?a[n]=m(e,r):"pivot"==i.type&&(a[n]=d(e,r));swivel.merge(t,a)}),t}var y=[],b=[],k=[],q=swivel.tree(),j=e||[],D={all:g,group:r,pivot:u,filter:i,config:t,concat:n,aggregate:a,count:o,countUnique:s,sum:l,average:c,median:f,stdDev:v};return D}swivel.tree=function(){function e(e){c.push(e)}function n(){return f}function t(){return s}function r(e){return l[e]}function u(e,n){f=!1,o(s,e,n,c,0)}function i(e,n,t){for(var r=c[n],u=l[r],i=Object.keys(u),a=0;a<i.length;a++){var o=i[a],s=e[o];t(s,o)}}function a(e,n,t,r,u){if(r==t.length)return u(n,e);for(var i=t[r],o=l[i],s=Object.keys(o),c=0;c<s.length;c++){var f=s[c],v=n[f];"undefined"!=typeof v&&(e[i]=f,a(e,v,t,r+1,u),delete e[i])}}function o(e,n,t,r,u){var i=r[u],a=n[i],s=u+1==r.length;i in l||(l[i]={}),a in l[i]||(l[i][a]=!0),a in e||(e[a]=s?[]:{}),s?e[a].push(t):o(e[a],n,t,r,u+1)}var s={},l={},c=[],f=!0,v={field:e,insert:u,isEmpty:n,getRoot:t,getValues:r,eachValue:i,eachBranch:a};return v},swivel.args=function(e){return Array.prototype.slice.call(e,0)},swivel.merge=function(e,n){for(var t in n)e[t]=n[t]},swivel.aggregate=function(e,n){switch(e){case"sum":return swivel.sum(n);case"count":return swivel.count(n);case"countUnique":return swivel.countUnique(n);case"average":return swivel.average(n);case"median":return swivel.median(n);case"stdDev":return swivel.stdDev(n);default:return swivel.sum(n)}},swivel.average=function(e){return function(n){var t=0/0;if(n.length>0){for(var r=0,u=0;u<n.length;u++)r+=n[u][e];t=r/n.length}return t}},swivel.count=function(){return function(e){return e.length}},swivel.countUnique=function(e){return function(n){for(var t={},r=0;r<n.length;r++){var u=+n[r][e];u in t||(t[u]=!0)}return Object.keys(t).length}},swivel.median=function(e){return function(n){for(var t=[],r=0;r<n.length;r++)t.push(+n[r][e]);var u=0/0;t.sort(function(e,n){return e-n});var i=Math.floor(t.length/2);return u=t.length%2?t[i]:t[i-1]+t[i]/2}},swivel.stdDev=function(e){var n=function(n){for(var t=0,r=0;r<n.length;r++)t+=n[r][e];return t/n.length},t=function(n,t){for(var r=[],u=0;u<t.length;u++){var i=t[u][e]-n;r.push(i*i)}return r};return function(e){if(0==e.length)return 0/0;for(var r=n(e),u=t(r,e),i=0,a=0;a<u.length;a++)i+=u[a];var o=i/u.length;return Math.sqrt(o)}},swivel.sum=function(e){return function(n){for(var t=0,r=0;r<n.length;r++){var u=+n[r][e];if(0/0===u)return 0/0;if("number"!=typeof u)return 0/0;t+=u}return t}};